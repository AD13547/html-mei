<html lang="zh-CN">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<title>åœ£è¯å¿«ä¹</title>
<style>
html,body{--overlay-bg: rgba(0,0,0,0); background: url("static/picture/1.jpg") center center / cover no-repeat; margin:0;padding:0;overflow:hidden;-webkit-text-size-adjust: 100% !important;text-size-adjust: 100% !important;-moz-text-size-adjust: 100% !important;height:100%;font-family:"PingFang SC","Microsoft YaHei",sans-serif}
#div_start_bg{width:100%;height:100vh;position:absolute;left:0;top:0;z-index:1;background:#fff;background-size:cover}
.modal-backdrop {position: fixed;inset: 0;display: grid;place-items: center;z-index: 9998;background-color: rgba(0, 0, 0, .5);display: none;}
.gift-modal{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:90%;max-width:380px;background:#fff;border-radius:12px;box-shadow:3px 3px 0 rgba(0,0,0,.2),0 0 12px 2px transparent;z-index:9999;border:1px solid #ffd6e0;display:none;overflow:hidden}
.gift-header{border-radius:10px 10px 0 0;padding:15px 20px;background:#ff87b8;color:#fff;font-size:19px;font-weight:700;display:flex;align-items:center;gap:10px;border-bottom:1px solid #ffb6c1}
.gift-content{padding:25px 20px;font-size:17px;color:#555;text-align:center;line-height:1.6;background:#fff;display:flex;flex-direction:column;}
.gift-btn{margin-top:15px;width:100%;padding:12px 0;background:#ff87b8;color:#fff;border:none;border-radius:8px;font-size:16px;cursor:pointer;transition:background .2s ease;box-shadow:2px 2px 0 rgba(255,105,180,.3);font-weight:500}
.gift-btn:active{background:#ff69b4;box-shadow:1px 1px 0 rgba(255,105,180,.3);transform:translate(1px,1px)}
.popup{z-index:999;position:absolute;width:280px;height:80px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.15);overflow:hidden;animation:bounceIn 0.4s cubic-bezier(0.175,0.885,0.32,1.275) forwards}
.titlebar{height:30px;line-height:30px;font-size:14px;font-weight:bold;padding:0 10px;display:flex;align-items:center;gap:8px}
.title-icon{font-size:18px}
.content{display:flex;justify-content:center;align-items:center;height:calc(100% - 30px);text-align:center;font-size:16px;font-weight:600}
.more-btn{position:fixed;width:38px;height:38px;border:2px solid #fff;border-radius:50%;font-size:13px;line-height:38px;text-align:center;bottom:60px;right:15px;background:rgba(0,0,0,0.2);z-index:99999;display:none}
.more-btn a{color:#fff;text-decoration:none;display:block;width:100%;height:100%}
@keyframes bounceIn{0%{opacity:0;transform:scale(0.8)}60%{opacity:1;transform:scale(1.1)}100%{opacity:1;transform:scale(1)}}
</style>
</head>
<body>
<audio id="bgMusic" src="static/3.mp3" preload="auto" loop></audio>
<div class="modal-backdrop open-box" id="start-backdrop">
    <div class="gift-modal" id="giftModal" style="display:none">
        <div class="gift-header"><span id="title-id">åœ£è¯ç¤¼ç‰©</span></div>
        <div class="gift-content">
            <span id="content-id">äº²çˆ±çš„ï¼Œä½ æœ‰ä¸€ä»½åœ£è¯èŠ‚ç¤¼ç‰©ï¼Œç¡®å®šè¦æ‰“å¼€å—ï¼Ÿ</span>
            <button class="gift-btn" id="confirmBtn">ç¡®å®š</button>
        </div>
    </div>
</div>
<div class="more-btn" id="more-btn"><a href="">æ›´å¤š</a></div>
<script>
// æ–°å¢ï¼šè·å–é®ç½©å±‚å…ƒç´  + è§„èŒƒå˜é‡é€—å·åˆ†éš”
const giftModal=document.getElementById('giftModal'),
      confirmBtn=document.getElementById('confirmBtn'),
      moreBtn=document.getElementById('more-btn'),
      audio=document.getElementById('bgMusic'),
      startBackdrop=document.getElementById('start-backdrop'); // é®ç½©å±‚DOM

const tempRes = {data:{sectionContent:'å¥½å¥½çˆ±è‡ªå·±|ä¸‡äº‹èƒœæ„|å²å²å¹³å®‰|åœ£è¯å¿«ä¹|å–œä¹é•¿å®‰|å¿«ä¹ä¸æ­¢ä»Šå¤©|é¡ºé¡ºåˆ©åˆ©'}};

// æ ¸å¿ƒæ–°å¢ï¼šæ”¶ä»¶äººå§“åç›¸å…³é…ç½®
let recipientName = "ä¸«å¤´~ "; // é»˜è®¤æ”¶ä»¶äººå§“å

// ä»URLæå–idå‚æ•°
function getUrlId(){
  return new URLSearchParams(window.location.search).get('id');
}

// æ ¹æ®idè¯·æ±‚åç«¯è·å–æ”¶ä»¶äººå§“å
async function fetchRecipientName(id){
  try{
    const res=await fetch(`get_recipient_info.php?id=${id}`,{mode:'cors',credentials:'same-origin'});
    if(!res.ok)throw new Error();
    const data=await res.json();
    return data.success&&data.recipientName?data.recipientName.trim():null;
  }catch(e){
    return null;
  }
}

// åˆå§‹åŒ–ä¸ªæ€§åŒ–å†…å®¹ï¼ˆæ›´æ–°å¼¹çª—æ–‡æœ¬ï¼‰
async function initPersonalization(){
  const id=getUrlId();
  if(id){
    const name=await fetchRecipientName(id);
    if(name){
      recipientName=name;
    }
  }
  // æ›´æ–°å¼¹çª—å†…å®¹ï¼ˆæ‹¼æ¥å§“åï¼‰
  const contentId=document.getElementById('content-id');
  contentId.textContent=`${recipientName}ï¼Œä½ æœ‰ä¸€ä»½åœ£è¯èŠ‚ç¤¼ç‰©ï¼Œç¡®å®šè¦æ‰“å¼€å—ï¼Ÿ`;
  
  // å…³é”®ä¿®æ”¹ï¼šåŒæ—¶æ˜¾ç¤ºé®ç½©å±‚å’Œå¼¹çª—
  startBackdrop.style.display='grid';
  giftModal.style.display='block';
}

// æ›´å¤šæŒ‰é’®é“¾æ¥åˆå§‹åŒ–
function initMoreBtnLink(){
  const moreLink=document.querySelector('.more-btn a');
  fetch('../domain.php').then(res=>{
    if(!res.ok)throw new Error(`è¯·æ±‚å¤±è´¥ï¼š${res.status}ï¼ˆæ£€æŸ¥domain.phpè·¯å¾„æ˜¯å¦æ­£ç¡®ï¼‰`);
    return res.json();
  }).then(data=>{
    if(data&&data.success&&typeof data.domain==='string'&&data.domain.trim()){
      moreLink.href=data.domain.trim();
      console.log('æ›´å¤šæŒ‰é’®é“¾æ¥åŠ è½½æˆåŠŸï¼š',data.domain);
    }else console.log('æ›´å¤šæŒ‰é’®é“¾æ¥æ ¼å¼é”™è¯¯ï¼šåç«¯è¿”å›æ•°æ®ä¸å®Œæ•´');
  }).catch(err=>console.log('æ›´å¤šæŒ‰é’®é“¾æ¥è·å–å¤±è´¥ï¼š',err.message));
}

// ç¡®å®šæŒ‰é’®ç‚¹å‡»äº‹ä»¶ï¼ˆæ’­æ”¾éŸ³é¢‘+æ˜¾ç¤ºæ›´å¤šæŒ‰é’®+å¯åŠ¨å¼¹çª—ï¼‰
confirmBtn.addEventListener('click',()=>{
  // ç›´æ¥æ’­æ”¾é¢„åŠ è½½å¥½çš„éŸ³é¢‘
  audio.play().catch(err=>console.log('éŸ³é¢‘æ’­æ”¾å¤±è´¥ï¼š',err.message));
  // æ˜¾ç¤ºæ›´å¤šæŒ‰é’®å¹¶åŠ è½½é“¾æ¥
  moreBtn.style.display='block';
  initMoreBtnLink();
  // å…³é”®ä¿®æ”¹ï¼šåŒæ—¶éšè—é®ç½©å±‚å’Œå¼¹çª—
  startBackdrop.style.display='none';
  giftModal.style.display='none';
  startPopupEffect();
});

function startPopupEffect(){
  const INTERVAL=150,WINDOW_WIDTH=280,WINDOW_HEIGHT=80,tips=tempRes.data.sectionContent.split('|');
  const titleGradients=['linear-gradient(to right,#fce4ec,#f8bbd0)','linear-gradient(to right,#e1f5fe,#b3e5fc)','linear-gradient(to right,#e8f5e9,#c8e6c9)','linear-gradient(to right,#fff8e1,#ffe0b2)','linear-gradient(to right,#f3e5f5,#ce93d8)','linear-gradient(to right,#ffe0b2,#ffcc80)','linear-gradient(to right,#e0f7fa,#b2ebf2)','linear-gradient(to right,#fff3e0,#ffe0b2)','linear-gradient(to right,#f1f8e9,#dcedc8)','linear-gradient(to right,#fbe9e7,#ffccbc)'];
  const contentBgColors=['#ffffff','#fff9c4','#e8f5e9','#e1f5fe','#fce4ec','#f3e5f5','#fff3e0','#e0f7fa'];
  const icons=['ğŸ’–','â¤ï¸','ğŸ’›','ğŸ’š','ğŸ’™','ğŸ’œ','ğŸ§¡','ğŸ’'];
  
  const random=(min,max)=>Math.random()*(max-min)+min;
  const createPopup=()=>{
    const popup=document.createElement('div');popup.className='popup';
    const grad=titleGradients[Math.floor(random(0,titleGradients.length))];
    const bg=contentBgColors[Math.floor(random(0,contentBgColors.length))];
    popup.style.left=`${random(20,window.innerWidth-WINDOW_WIDTH-20)}px`;
    popup.style.top=`${random(50,window.innerHeight-WINDOW_HEIGHT-50)}px`;
    
    const titlebar=document.createElement('div');
    titlebar.className='titlebar';titlebar.style.background=grad;
    titlebar.innerHTML=`<span class="title-icon">${icons[Math.floor(random(0,icons.length))]}</span><span>æç¤º</span>`;
    
    const content=document.createElement('div');
    content.className='content';content.style.backgroundColor=bg;
    // æ ¸å¿ƒä¿®æ”¹ï¼šç¥ç¦æ–‡æœ¬å‰æ‹¼æ¥æ”¶ä»¶äººå§“å
    content.textContent=`${recipientName}ï¼Œ${tips[Math.floor(random(0,tips.length))]}`;
    
    popup.appendChild(titlebar);popup.appendChild(content);
    document.body.appendChild(popup);
  };
  setInterval(createPopup,INTERVAL);
}

// é¡µé¢åŠ è½½æ—¶ç«‹å³æ‰§è¡Œä¸ªæ€§åŒ–åˆå§‹åŒ–
window.addEventListener('load', initPersonalization);

// åˆå¹¶åˆ°æ­¤å¤„ï¼šæ—¶é—´æˆ³hashåŠŸèƒ½ï¼ˆåŸæœ‰ä»£ç æœ«å°¾æ·»åŠ ï¼‰
function addTimestampHash() {
  const timestamp = Date.now();
  window.location.hash = timestamp;
}

if (document.readyState === "loading") {
  document.addEventListener("DOMContentLoaded", addTimestampHash);
} else {
  addTimestampHash();
}
</script>
</body>
</html>